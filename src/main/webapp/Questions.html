<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Question</title>
    <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
    <link rel="stylesheet" type="text/css" href="Style.css">
    <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="http://cdn.datatables.net/1.10.9/js/jquery.dataTables.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="jquery-3.2.1.min.js"></script>
    <script language="javascript">

        var round = 0;

        var answerChosen;

        var correctAnswer;

        var nickname;

        var quizIndex;

        var quizName;

        var countdown;

        var numberOfQuestions;

        var quizLength;

        var endDate;

        var newDate;

        var interval;

        //var haveloadedquestions = -1;
        /**
         * Runs when site is opened.
         * Sets parameters quizName, nickname, startingdate.
         */
        $(document).ready(function() {

            quizName = getParameterByName('quizName');
            nickname= getParameterByName('nickname');


            $.get("rest/quizzes/", function (quizzes) {
                if (quizzes != null) {

                    for(i = 0; i < quizzes.length; i++){
                        if(quizzes[i].name == quizName){ //finding the index in the array of the quiz
                            quizIndex = i;
                        }
                    }

                    $("#quizName").append('' + quizName + ''); //sets the headline "quiz name"

                    newDate = new Date(quizzes[quizIndex].startTime); //creates the date when the quiz starts
                    var outputDate = newDate.getDate() + "/" + (newDate.getMonth() + 1) + "/" + newDate.getFullYear() + ", at " + newDate.getHours() + ":" + newDate.getMinutes();

                    /*quizLength = quizzes[quizIndex].totalTime; //all the questions timelimit summed
                    endDate = new Date(quizzes[quizIndex].startTime);
                    endDate.setSeconds(endDate.getSeconds() + quizLength);*/

                    $("#quizStarts").append('' + outputDate + ''); //sets the headline "quiz name"

                    //console.log("round: " + round);
                }
            });
        });

        /**
         * Counts down the question timelimit
         */
        function countdownFunction(){
            countdown -= 1;
            if(countdown >= 0) {
                document.getElementById("timer").innerHTML = "Time left this question: " + countdown;

                if(countdown <= 10){
                    //document.getElementById("timer").innerHTML = '<div class="bg-danger">Time left this question:' + countdown + '</div>';

                    document.getElementById("timer").style.color="red";
                }
                if(countdown > 10){
                    //document.getElementById("timer").innerHTML = "Time left this question: " + countdown;
                    document.getElementById("timer").style.color="black";

                }
            }
            else{
                submit();
            }
        }


        /**
         * Checks if the current time > start time to check when the quiz should start.
         */
        var interval2 = setInterval(checkTime, 1000);
        function checkTime(){
            var currentTime = new Date();
            var secoundsInto;

            if(currentTime < newDate){ //har ikke begynt enda
                document.getElementById("question").innerHTML = "Secounds until start: " + Math.round((newDate-currentTime)/1000) + "";
            }
            else{
                clearInterval(interval2);
                $("#button").append('<button id="submit" type="button" class="btn btn-success btn-lg" onclick="submit()">Submit answer</button>');
                document.getElementById("question").innerHTML = "";

                /*$.get("rest/quizzes/" + quizName + "/questions", function (questions) {
                    secoundsInto = Math.round((currentTime - newDate)/1000);
                    var ok = true;
                    var i = 0;
                    while(ok == true && i < questions.length){
                        console.log("Secoundsinto: " + secoundsInto);
                        console.log("i = " + i + "\nquestions.length = " + questions.length);

                        if((secoundsInto) > questions[i].timeLimit){
                            round += 1;
                            secoundsInto -= questions[i].timeLimit;
                        } else {
                            ok = false;
                        }
                        i++;
                    }



                });*/

                //countdown = questions[round].timeLimit;

                countdown = 10;
                interval = setInterval(countdownFunction, 1000);
                loadQuestion();
            }

        }

        /**
         * Running everytime a question selection is selected.
         * Sets the variable answerchosen.
         * @param val
         */

        function selectAnswer(val){
            answerChosen = val;
        }

        /**
         * Running everytime an answer is submitted and when the time for a question runs out.
         * Checks if the answer is correct, if so a point is added to the player/nick.
         */
        function submit() {
            if (answerChosen != null) {
                if (answerChosen == correctAnswer) {
                    $.ajax({
                        url: 'rest/quizzes/' + quizName + '/players/' + nickname,
                        type: 'PUT',
                        //data: '1',
                        contentType: 'application/json; charset=utf-8',
                        dataType: 'json',

                        success: function (result) {
                            alert("Correct answer! 1 point to you!");
                        },
                        statusCode: {
                            404: function () {
                                alert("404: could not find user");
                            }

                        },


                    });


                }else{
                    alert("Sorry wrong answer..")
                }
            } else{
                alert("You didn't chose an answer. No points for you..")
            }
            showScoreboard();
            round += 1;
            loadQuestion();

        };


        /**
         * Loads the next question.
         * Removes the previous question if we are on round >0.
         */
        function loadQuestion() {

            var currentTime = new Date();

            //console.log("round: " + round);

            $.get("rest/quizzes/" + quizName + "/questions", function(questions) { //gets all the questions for the quiz

                if (round > 0) {
                    $("#timer").remove();
                    $("#quest").remove();
                    $("#answeroptions").remove();
                    $("#answeroptions").remove();
                    $("#answeroptions").remove();
                    $("#answeroptions").remove();
                    $("#answerText").remove();
                    $("#answerText").remove();
                    $("#answerText").remove();
                    $("#answerText").remove();
                    $("#space").remove();
                    $("#space").remove();
                    $("#space").remove();
                    $("#space").remove();
                    $("#questpic").remove();

                }
                //console.log("round: " + round + "\nq-length: " + questions.length);
                if (round != questions.length) { //we are not done with the quiz

                    countdown = questions[round].timeLimit;
                    //console.log("timelimit: " + countdown);
                    //console.log("question: " + questions[round].question);

                    $("#timeLeft").append('<p id="timer" type="number">Time for this question: ' + countdown + '</p>'); //sets the time that the quiz started

                    $("#question").append('<p id="quest">Question: ' + questions[round].question + '</p>');

                    if(questions[round].url != null){ //adds at the picture if url in the question is not null
                        $("#picture").append('<img id="questpic" class="col-sm-6" src="' + questions[round].url + '" alt="Error in loading picture.." width="100%" height="100%">'); //sets the first question')
                    }//$("#picture").append('<img id="questpic" src="' + questions[round].url + '" alt="Error in loading picture.." width="50%">'); //sets the first question

                    correctAnswer = questions[round].rightAnswerIndex;
                    //console.log("correct: " + correctAnswer);


                    for (i = 0; i < 4; i++) { //adds all the answer-alternatives
                        $("#answers").append('<p id="answerText"><input type="radio" name="answer" id="answeroptions" onclick="selectAnswer(' + i + ')">' + questions[round].answers[i] + '</p><br id="space">');
                    }

                } else{ //the quiz is over (the last question has been on the screen)
                    clearInterval(interval);
                    $("#quizStarts").remove();
                    $("#submit").remove();
                    $("#finish").append('<h2>The quiz is now over! Click the button to see scoreboard!</h2><br>'+
                        '<button id="scoreBoard" type="button" class="btn btn-primary btn-block" onclick="showScoreboard()">Scoreboard</button>');


                }

                //haveloadedquestions = 1;

            });
        }

        /**
         * Shows the scoreboard on an alert.
         * Could also put this code into another site to have a seperate scoreboard-site.
         */
        function showScoreboard(){
            var text = "!LIVE SCOREBOARD!\n";
            var placing = 1;

            $.get("rest/quizzes/" + quizName + "/players", function (data) {

                if(data != null) {
                    for (i = 0; i < data.length && i < 10; i++) {
                        if(data[i] != null) {
                            text += (placing) + " : " + data[i].nickname + ", score: " + data[i].score + "\n";
                            placing += 1;
                        }
                    }
                }

                alert(text);

            });
        }

        /**
         * Premade code that gets out the nickname and the quizname as parameters in the url.
         *
         * @param name
         * @param url
         * @returns {*}
         */
        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }
    </script>
</head>
<body>
<ul id="topMenu">
    <li id="topMenuOptions"><img id="toplogo" src="https://image.ibb.co/mM8dUQ/Les_Quizerables.jpg" alt="Logo" height="100" width="200"></li>
    <li id="topMenuOptions"><a href="Frontpage.html">Home</a></li>
    <li id="topMenuOptions"><a href="MainWindow.html">Start quizzing!</a></li>
    <li id="topMenuOptions"><a href="regNewQuiz.html">Create new quiz</a></li>
</ul>
<a></a>
<div class="container">
<h2 id="quizName">Quiz: </h2>
<h2 id="quizStarts">Quiz start(ed) at: </h2>
    <h2 id="timeuntilStart"></h2>
</div>
<div class="container" id="qBox">
    <div class="row">
        <div class="col-sm-12">
            <h4 id="finish"></h4>
        </div>
        <div class="col-sm-6">
        <h4 id="timeLeft"></h4>
        <h3 id="question"></h3>
        <div id="answers"></div>

            <div id="button"></div><!--<button id="submit" type="button" class="btn btn-success btn-lg" onclick="submit()">Submit answer</button>-->
        </div>
        <div class="col-sm-6">
        <p id="picture"></p>
        </div>
    </div>
</div>
<br>
</body>
</html>